<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東方Project リプレイ情報表示</title>
    <link rel="stylesheet" type="text/css" href="Style.css">
    <link rel="icon" type="image/png" href="Icon.png">
    <link href="https://unpkg.com/tabulator-tables@4.4.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.4.1/dist/js/tabulator.min.js"></script>
    <style>
        body {
            margin: 0 0 30%;
        }

        #result {
            display: none;
            margin: auto -2em;
        }
    </style>
    <script>
        addEventListener("load", function () {
            const textDecoder = new TextDecoder("windows-31j");
            const scoreFormatter = new Intl.NumberFormat("ja");

            const table = new Tabulator("#result", {
                layout: "fitDataFill",
                columns: [
                    { title: "ファイル名", field: "fileName" },
                    { title: "ゲーム名", field: "game.name", sorter: gameSorter },
                    { title: "プレイヤー名", field: "info.playerName" },
                    { title: "プレイ日時", field: "info.dateTime" },
                    { title: "タイプ", field: "info.type" },
                    { title: "スコア", field: "info.score", align: "right", sorter: "number" },
                    { title: "難易度", field: "info.rank", sorter: rankSorter },
                    { title: "ステージ", field: "info.stage" },
                    { title: "処理落ち率", field: "info.slowRate", align: "right", sorter: "number" },
                    { title: "ゲームのバージョン", field: "info.version", align: "right" }
                ],
                initialSort: [
                    { column: "fileName", dir: "asc" },
                    { column: "game.name", dir: "asc" },
                ],
                rowDblClick: function (e, row) {
                    const rawData = row.getData().rawData;
                    if (rawData) {
                        alert(rawData);
                    }
                }
            });

            const games = [
                { magic: "T6RP", number: 6, name: "東方紅魔郷" },
                { magic: "T7RP", number: 7, name: "東方妖々夢" },
                { magic: "T8RP", number: 8, name: "東方永夜抄", rawDataStart: "プレイヤー名", getInfo: get永夜抄Info },
                { magic: "T9RP", number: 9, name: "東方花映塚", rawDataStart: "プレイヤー名", getInfo: get花映塚Info },
                { magic: "t95r", number: 9.5, name: "東方文花帖", rawDataStart: "東方文花帖 リプレイファイル情報", getInfo: get文花帖Info },
                { magic: "t10r", number: 10, name: "東方風神録", rawDataStart: "東方風神録 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t11r", number: 11, name: "東方地霊殿", rawDataStart: "東方地霊殿 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t12r", number: 12, name: "東方星蓮船", rawDataStart: "東方星蓮船 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t125", number: 12.5, name: "ダブルスポイラー", rawDataStart: "東方文花帖 リプレイファイル情報", getInfo: getダブルスポイラーInfo },
                { magic: "128r", number: 12.8, name: "妖精大戦争", rawDataStart: "東方星蓮船 リプレイファイル情報", getInfo: get妖精大戦争Info },
                { magic: "t13r", number: 13, name: "東方神霊廟", rawDataStart: "東方神霊廟 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t13r", number: 14, name: "東方輝針城", rawDataStart: "東方輝針城 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t143", number: 14.3, name: "弾幕アマノジャク", rawDataStart: "弾幕アマノジャク リプレイファイル情報", getInfo: get弾幕アマノジャクInfo },
                { magic: "t15r", number: 15, name: "東方紺珠伝", rawDataStart: "東方紺珠伝 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t16r", number: 16, name: "東方天空璋", rawDataStart: "東方天空璋 リプレイファイル情報", getInfo: get風神録Info },
                { magic: "t156", number: 16.5, name: "秘封ナイトメアダイアリー", rawDataStart: "秘封ナイトメアダイアリー リプレイファイル情報", getInfo: get弾幕アマノジャクInfo },
                { magic: "t17r", number: 17, name: "東方鬼形獣", rawDataStart: "東方鬼形獣 リプレイファイル情報", getInfo: get風神録Info }
            ];

            const ranks = ["Easy", "Normal", "Hard", "Lunatic", "Extra", "Phantasm", "O.D."];

            function gameSorter(a, b, aRow, bRow, column, dir, sorterParams) {
                return aRow.getData().game.number - bRow.getData().game.number;
            }

            function rankSorter(a, b, aRow, bRow, column, dir, sorterParams) {
                return ranks.indexOf(a) - ranks.indexOf(b);
            }

            addEventListener("dragover", function (event) {
                event.preventDefault();
            });

            addEventListener("drop", function (event) {
                event.preventDefault();
                process(event.dataTransfer.files);
            });

            document.forms[0].files.addEventListener("change", function () {
                process(this.files);
            });

            async function process(fileList) {
                result.style.display = "block";

                const files = Array.from(fileList);
                const tableData = (await Promise.all(files.map(getData))).filter(i => i);
                table.setData(tableData);
            }

            async function getData(file) {
                try {
                    const data = {
                        fileName: file.name
                    };

                    // const byteArray = new Uint8Array(await file.arrayBuffer());
                    const byteArray = new Uint8Array(await readFileAsync(file));

                    const game = getGame(byteArray);
                    data.game = game;

                    if (game.rawDataStart) {
                        const rawData = getRawData(byteArray, game.rawDataStart);
                        data.rawData = rawData;

                        data.info = game.getInfo(rawData);
                    }

                    return data;
                } catch (e) {
                    console.log(e);
                    return null;
                }
            }

            // https://simon-schraeder.de/posts/filereader-async/
            function readFileAsync(file) {
                return new Promise((resolve, reject) => {
                    let reader = new FileReader();

                    reader.onload = () => {
                        resolve(reader.result);
                    };

                    reader.onerror = reject;

                    reader.readAsArrayBuffer(file);
                })
            }

            function getGame(byteArray) {
                const magic = textDecoder.decode(byteArray.subarray(0, 4));

                const candidates = games.filter(g => g.magic == magic);

                if (candidates.length <= 1) {
                    return candidates[0];
                }

                const all = textDecoder.decode(byteArray);
                return candidates.filter(g => all.includes(g.rawDataStart))[0];
            }

            function getRawData(byteArray, start) {
                const all = textDecoder.decode(byteArray);
                const index = all.indexOf(start);
                return all.substr(index);
            }

            function get永夜抄Info(rawData) {
                const entries = get永夜抄Entries(rawData, 11);

                let stage = entries["最終ステージ"];
                if (!stage) {
                    stage = entries["カード名"];
                }

                // ミス回数とボム回数と人間率を表示していない。
                return {
                    playerName: entries["プレイヤー名"],
                    dateTime: entries["プレイ時刻"],
                    type: entries["キャラ名"],
                    score: scoreFormatter.format(entries["スコア"]),
                    rank: entries["難易度"],
                    stage: stage,
                    slowRate: entries["処理落ち率"],
                    version: entries["ゲームのバージョン"]
                };
            }

            function get永夜抄Entries(rawData, limit) {
                return rawData.split(/[ 　]*\r\n/, limit)
                    .map(r => r.split(/\t+/, 2))
                    .filter(r => r.length == 2)
                    .reduce((result, row) => {
                        result[row[0]] = row[1];
                        return result;
                    }, {});
            }

            function get花映塚Info(rawData) {
                const entries = get永夜抄Entries(rawData, 8);

                // モードと初期体力を表示していない。
                return {
                    playerName: entries["プレイヤー名"],
                    dateTime: "20" + entries["プレイ時刻"],
                    type: entries["使用キャラ"],
                    rank: entries["難易度"],
                    version: entries["ゲームのバージョン"].substr(10)
                };
            }

            function get文花帖Info(rawData) {
                const entries = get文花帖Entries(rawData, 9);

                return {
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    score: scoreFormatter.format(entries["Score"]),
                    stage: entries["Level"] + "-" + entries["Scene"],
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }

            function get文花帖Entries(rawData, limit) {
                return entries = rawData.split(/ *\r\n/, limit)
                    .map(r => r.match(/(Slow Rate|.*?) (.*)/))
                    .filter(r => r.length == 3)
                    .reduce((result, row) => {
                        result[row[1]] = row[2];
                        return result;
                    }, {});
            }

            function get風神録Info(rawData) {
                const entries = get文花帖Entries(rawData, 9);
                return create風神録Info(entries);
            }

            function create風神録Info(entries) {
                let stage = entries["Stage"];
                if (!stage) {
                    stage = "Extra " + entries["Extra"];
                }

                return {
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    type: entries["Chara"],
                    score: scoreFormatter.format(parseInt(entries["Score"]) * 10),
                    rank: entries["Rank"],
                    stage: stage,
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }

            function getダブルスポイラーInfo(rawData) {
                const entries = get文花帖Entries(rawData, 9);
                const info = create風神録Info(entries);

                info.stage = entries[""];

                return info;
            }

            function get妖精大戦争Info(rawData) {
                const entries = get文花帖Entries(rawData, 9);
                const info = create風神録Info(entries);

                info.stage = entries["Route"] + " " + info.stage;

                return info;
            }

            function get弾幕アマノジャクInfo(rawData) {
                const entries = get文花帖Entries(rawData, 9);
                const info = create風神録Info(entries);

                info.stage = entries["Day"] + "-" + entries["Scene"];

                return info;
            }
        });
    </script>
    <meta name="author" content="Itaru">
</head>

<body>
    <header>
        <a href="/"><img src="Logo.svg" width="400" height="80" alt="トップページへ"></a>
        <dl>
            <dt>最終更新</dt>
            <dd>2019年9月16日 7時0分</dd>
        </dl>
    </header>
    <h1>東方Project リプレイ情報表示</h1>
    <div id="result"></div>
    <form>
        <p>リプレイファイルを選択するか、このページにドロップしてください。</p>
        <input type="file" name="files" accept=".rpy" multiple>（複数指定可）
    </form>
    <footer>
        <dl>
            <dt>作成</dt>
            <dd>Itaru</dd>
            <dt>初版公開</dt>
            <dd>2019年9月16日</dd>
        </dl>
    </footer>
</body>

</html>