<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東方Project リプレイ情報表示</title>
    <link rel="stylesheet" type="text/css" href="Style.css">
    <link rel="icon" type="image/png" href="Icon.png">
    <link href="https://unpkg.com/tabulator-tables@4.4.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.4.1/dist/js/tabulator.min.js"></script>
    <style>
        body {
            margin: 0 0 30%;
        }

        #result {
            display: none;
            margin: auto -2em;
        }
    </style>
    <script>
        addEventListener("load", function () {
            const textDecoder = new TextDecoder("windows-31j");

            const table = new Tabulator("#result", {
                layout: "fitDataFill",
                columns: [
                    { title: "ファイル名", field: "fileName" },
                    { title: "ゲーム No.", field: "game.number", align: "right", sorter: "number" },
                    { title: "ゲーム名", field: "game.name" },
                    { title: "プレイヤー名", field: "replay.playerName" },
                    { title: "プレイ日時", field: "replay.dateTime" },
                    { title: "タイプ", field: "replay.type" },
                    { title: "スコア", field: "replay.score", align: "right", sorter: "number" },
                    { title: "難易度", field: "replay.rank" },
                    { title: "ステージ", field: "replay.stage" },
                    { title: "処理落ち率", field: "replay.slowRate", align: "right", sorter: "number" },
                    { title: "ゲームのバージョン", field: "replay.version", align: "right" }
                ],
                initialSort: [
                    { column: "fileName", dir: "asc" },
                    { column: "game.number", dir: "asc" },
                ],
                rowDblClick: function (e, row) {
                    const replay = row.getData().replay;
                    if (replay) {
                        alert(replay.rawData);
                    }
                }
            });

            const games = [
                { magic: "T6RP", number: 6, name: "東方紅魔郷", read: read紅魔郷 },
                { magic: "T7RP", number: 7, name: "東方妖々夢", read: read紅魔郷 },
                { magic: "T8RP", number: 8, name: "東方永夜抄", read: read永夜抄 },
                { magic: "T9RP", number: 9, name: "東方花映塚", read: read花映塚 },
                { magic: "t95r", number: 9.5, name: "東方文花帖", read: read文花帖 },
                { magic: "t10r", number: 10, name: "東方風神録", read: read風神録 },
                { magic: "t11r", number: 11, name: "東方地霊殿", read: read風神録 },
                { magic: "t12r", number: 12, name: "東方星蓮船", read: read風神録 },
                { magic: "t125", number: 12.5, name: "ダブルスポイラー", read: readダブルスポイラー },
                { magic: "128r", number: 12.8, name: "妖精大戦争", read: read妖精大戦争 },
                { magic: "t13r", number: 13, name: "東方神霊廟", read: read風神録 },
                { magic: "t13r", number: 14, name: "東方輝針城", read: read風神録 },
                { magic: "t143", number: 14.3, name: "弾幕アマノジャク", read: read弾幕アマノジャク },
                { magic: "t15r", number: 15, name: "東方紺珠伝", read: read風神録 },
                { magic: "t16r", number: 16, name: "東方天空璋", read: read風神録 },
                { magic: "t156", number: 16.5, name: "秘封ナイトメアダイアリー", read: read弾幕アマノジャク },
                { magic: "t17r", number: 17, name: "東方鬼形獣", read: read風神録 }
            ];

            addEventListener("dragover", function (event) {
                event.preventDefault();
            });

            addEventListener("drop", function (event) {
                event.preventDefault();
                process(event.dataTransfer.files);
            });

            document.forms[0].files.addEventListener("change", function () {
                process(this.files);
            });

            async function process(fileList) {
                result.style.display = "block";

                const files = Array.from(fileList);
                const tableData = (await Promise.all(files.map(getReplayInfo))).filter(i => i);
                table.setData(tableData);
            }

            async function getReplayInfo(file) {
                try {
                    const info = {
                        fileName: file.name
                    };

                    // const byteArray = new Uint8Array(await file.arrayBuffer());
                    const byteArray = new Uint8Array(await readFileAsync(file));

                    const game = getGame(byteArray);
                    info.game = game;

                    if (game && game.read) {
                        info.replay = game.read(byteArray);
                    }

                    return info;
                } catch (e) {
                    console.log(e);
                    return null;
                }
            }

            // https://simon-schraeder.de/posts/filereader-async/
            function readFileAsync(file) {
                return new Promise((resolve, reject) => {
                    let reader = new FileReader();

                    reader.onload = () => {
                        resolve(reader.result);
                    };

                    reader.onerror = reject;

                    reader.readAsArrayBuffer(file);
                })
            }

            function getGame(byteArray) {
                const magic = textDecoder.decode(byteArray.subarray(0, 4));

                const candidates = games.filter(g => g.magic == magic);

                if (candidates.length <= 1) {
                    return candidates[0];
                }

                const all = textDecoder.decode(byteArray);
                return candidates.filter(g => all.includes(g.name))[0];
            }

            function read紅魔郷() {
                return {
                    playerName: "-",
                    dateTime: "-",
                    type: "-",
                    score: "-",
                    rank: "-",
                    stage: "-",
                    slowRate: "-",
                    version: "-"
                };
            }

            function read永夜抄(byteArray) {
                const rawData = getRawData(byteArray, "プレイヤー名");
                const entries = get永夜抄Entries(rawData, 11);

                let stage = entries["最終ステージ"];
                if (!stage) {
                    stage = entries["カード名"];
                }

                return {
                    rawData: rawData,
                    playerName: entries["プレイヤー名"],
                    dateTime: entries["プレイ時刻"],
                    type: entries["キャラ名"],
                    score: entries["スコア"],
                    rank: entries["難易度"],
                    stage: stage,
                    slowRate: entries["処理落ち率"],
                    version: entries["ゲームのバージョン"]
                };
            }

            function getRawData(byteArray, start) {
                const all = textDecoder.decode(byteArray);
                const index = all.indexOf(start);
                return all.substr(index);
            }

            function get永夜抄Entries(rawData, limit) {
                return rawData.split(/[ 　]*\r\n/, limit)
                    .map(r => r.split(/\t+/, 2))
                    .filter(r => r.length == 2)
                    .reduce((result, row) => {
                        result[row[0]] = row[1];
                        return result;
                    }, {});
            }

            function read花映塚(byteArray) {
                const rawData = getRawData(byteArray, "プレイヤー名");
                const entries = get永夜抄Entries(rawData, 8);

                // モードと初期体力を表示していない。
                return {
                    rawData: rawData,
                    playerName: entries["プレイヤー名"],
                    dateTime: "20" + entries["プレイ時刻"],
                    type: entries["使用キャラ"],
                    score: "-",
                    rank: entries["難易度"],
                    stage: "-",
                    slowRate: "-",
                    version: entries["ゲームのバージョン"].substr(10)
                };
            }

            function read文花帖(byteArray) {
                const rawData = getRawData(byteArray, "東方文花帖 リプレイファイル情報");
                const entries = get文花帖Entries(rawData, 9);

                return {
                    rawData: rawData,
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    type: "-",
                    score: entries["Score"],
                    rank: "-",
                    stage: entries["Level"] + "-" + entries["Scene"],
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }

            function get文花帖Entries(rawData, limit) {
                return entries = rawData.split(/ *\r\n/, limit)
                    .map(r => r.match(/(Slow Rate|.*?) (.*)/))
                    .filter(r => r.length == 3)
                    .reduce((result, row) => {
                        result[row[1]] = row[2];
                        return result;
                    }, {});
            }

            function read風神録(byteArray) {
                const rawData = getRawData(byteArray, `${this.name} リプレイファイル情報`);
                const entries = get文花帖Entries(rawData, 9);

                let stage = entries["Stage"];
                if (!stage) {
                    stage = "Extra " + entries["Extra"];
                }

                return {
                    rawData: rawData,
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    type: entries["Chara"],
                    score: entries["Score"] + "0",
                    rank: entries["Rank"],
                    stage: stage,
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }

            function readダブルスポイラー(byteArray) {
                const rawData = getRawData(byteArray, "東方文花帖 リプレイファイル情報");
                const entries = get文花帖Entries(rawData, 9);

                return {
                    rawData: rawData,
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    type: entries["Chara"],
                    score: entries["Score"] + "0",
                    rank: "-",
                    stage: entries[""],
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }

            function read妖精大戦争(byteArray) {
                const rawData = getRawData(byteArray, "東方星蓮船 リプレイファイル情報");
                const entries = get文花帖Entries(rawData, 9);

                let stage = entries["Stage"];
                if (!stage) {
                    stage = "Extra " + entries["Extra"];
                }

                // Route を表示していない。
                return {
                    rawData: rawData,
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    type: "-",
                    score: entries["Score"] + "0",
                    rank: entries["Rank"],
                    stage: entries["Stage"],
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }

            function read弾幕アマノジャク(byteArray) {
                const rawData = getRawData(byteArray, `${this.name} リプレイファイル情報`);
                const entries = get文花帖Entries(rawData, 9);

                return {
                    rawData: rawData,
                    playerName: entries["Name"],
                    dateTime: "20" + entries["Date"],
                    type: "-",
                    score: entries["Score"] + "0",
                    rank: "-",
                    stage: entries["Day"] + "-" + entries["Scene"],
                    slowRate: entries["Slow Rate"] + "%",
                    version: entries["Version"]
                };
            }
        });
    </script>
    <meta name="author" content="Itaru">
</head>

<body>
    <header>
        <a href="/"><img src="Logo.svg" width="400" height="80" alt="トップページへ"></a>
        <dl>
            <dt>最終更新</dt>
            <dd>2019年9月16日 7時0分</dd>
        </dl>
    </header>
    <h1>東方Project リプレイ情報表示</h1>
    <div id="result"></div>
    <form>
        <p>リプレイファイルを選択するか、このページにドロップしてください。</p>
        <input type="file" name="files" accept=".rpy" multiple>（複数指定可）
    </form>
    <footer>
        <dl>
            <dt>作成</dt>
            <dd>Itaru</dd>
            <dt>初版公開</dt>
            <dd>2019年9月16日</dd>
        </dl>
    </footer>
</body>

</html>